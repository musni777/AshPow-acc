<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced NPV Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .calculator-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .input-section, .result-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 300px;
    }

    label, input, button, select {
      display: block;
      width: 100%;
      margin-bottom: 15px;
    }

    input, button, select {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    .result {
      background: #e0f7e9;
      border: 1px solid #b2dfdb;
      padding: 15px;
      margin-top: 20px;
      font-weight: bold;
      color: #2e7d32;
      border-radius: 4px;
    }

    .cashflow-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .cashflow-group input {
      flex: 1;
    }

    .metrics-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .metric-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin-top: 5px;
    }

    .positive {
      color: #2e7d32;
    }

    .negative {
      color: #c62828;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 20px;
      background: #ddd;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Advanced NPV Calculator with Accounting Features</h1>
  
  <div class="calculator-container">
    <div class="input-section">
      <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'basic')">Basic</div>
        <div class="tab" onclick="openTab(event, 'advanced')">Advanced</div>
      </div>

      <div id="basic" class="tab-content active">
        <label for="initialInvestment">Initial Investment (Rs.):</label>
        <input type="number" id="initialInvestment" placeholder="Enter initial investment" />

        <label for="discountRate">Discount Rate (%):</label>
        <input type="number" id="discountRate" placeholder="Enter discount rate" value="10" />

        <label for="numPeriods">Number of Periods (Years):</label>
        <input type="number" id="numPeriods" placeholder="e.g., 5" />

        <button onclick="generateCashFlows()">Add Cash Flow Inputs</button>

        <div id="cashFlowsContainer"></div>

        <label for="taxRate">Corporate Tax Rate (%):</label>
        <input type="number" id="taxRate" placeholder="Enter tax rate" value="30" />

        <label for="inflationRate">Inflation Rate (%):</label>
        <input type="number" id="inflationRate" placeholder="Enter inflation rate" value="2" />

        <button onclick="calculateAllMetrics()">Calculate All Metrics</button>
      </div>

      <div id="advanced" class="tab-content">
        <label for="depreciationMethod">Depreciation Method:</label>
        <select id="depreciationMethod">
          <option value="straight">Straight Line</option>
          <option value="double">Double Declining</option>
          <option value="none">None</option>
        </select>

        <label for="salvageValue">Salvage Value (Rs.):</label>
        <input type="number" id="salvageValue" placeholder="Enter salvage value" value="0" />

        <label for="workingCapital">Working Capital Change (Rs.):</label>
        <input type="number" id="workingCapital" placeholder="Enter working capital change" value="0" />

        <label for="growthRate">Cash Flow Growth Rate (%):</label>
        <input type="number" id="growthRate" placeholder="Enter growth rate" value="0" />

        <label>
          <input type="checkbox" id="includeInflation"> Adjust for Inflation
        </label>
      </div>
    </div>

    <div class="result-section">
      <h2>Investment Analysis</h2>
      
      <div class="metrics-container">
        <div class="metric-card">
          <div>Net Present Value (NPV)</div>
          <div class="metric-value" id="npvResult">Rs. 0.00</div>
        </div>
        
        <div class="metric-card">
          <div>Internal Rate of Return (IRR)</div>
          <div class="metric-value" id="irrResult">0.00%</div>
        </div>
        
        <div class="metric-card">
          <div>Payback Period</div>
          <div class="metric-value" id="paybackResult">0 years</div>
        </div>
        
        <div class="metric-card">
          <div>Profitability Index</div>
          <div class="metric-value" id="piResult">0.00</div>
        </div>
      </div>

      <div class="result" id="decisionResult">
        Investment Decision: Please calculate to see results
      </div>

      <h3>Cash Flow Timeline</h3>
      <div id="cashFlowTable"></div>

      <h3>Depreciation Schedule</h3>
      <div id="depreciationTable"></div>

      <h3>NPV Sensitivity Analysis</h3>
      <div class="chart-container" id="npvChart"></div>
    </div>
  </div>

  <script>
    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }

      const tabs = document.getElementsByClassName("tab");
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove("active");
      }

      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    function generateCashFlows() {
      const container = document.getElementById("cashFlowsContainer");
      container.innerHTML = ""; // clear previous
      const periods = parseInt(document.getElementById("numPeriods").value);

      for (let i = 1; i <= periods; i++) {
        const div = document.createElement("div");
        div.className = "cashflow-group";
        div.innerHTML = `
          <label>Year ${i} Cash Flow (Rs.)</label>
          <input type="number" id="cashflow${i}" placeholder="Enter cash flow for year ${i}" />
        `;
        container.appendChild(div);
      }
    }

    function calculateAllMetrics() {
      // Basic inputs
      const initialInvestment = parseFloat(document.getElementById("initialInvestment").value) || 0;
      const discountRate = parseFloat(document.getElementById("discountRate").value) / 100 || 0;
      const periods = parseInt(document.getElementById("numPeriods").value) || 0;
      const taxRate = parseFloat(document.getElementById("taxRate").value) / 100 || 0;
      const inflationRate = parseFloat(document.getElementById("inflationRate").value) / 100 || 0;
      const includeInflation = document.getElementById("includeInflation").checked;
      
      // Advanced inputs
      const depreciationMethod = document.getElementById("depreciationMethod").value;
      const salvageValue = parseFloat(document.getElementById("salvageValue").value) || 0;
      const workingCapital = parseFloat(document.getElementById("workingCapital").value) || 0;
      const growthRate = parseFloat(document.getElementById("growthRate").value) / 100 || 0;

      // Get cash flows
      let cashFlows = [];
      for (let i = 1; i <= periods; i++) {
        const cashFlow = parseFloat(document.getElementById(`cashflow${i}`).value) || 0;
        cashFlows.push(cashFlow);
      }

      // Adjust for growth rate
      if (growthRate !== 0) {
        for (let i = 1; i < cashFlows.length; i++) {
          cashFlows[i] = cashFlows[i-1] * (1 + growthRate);
          document.getElementById(`cashflow${i+1}`).value = cashFlows[i].toFixed(2);
        }
      }

      // Calculate depreciation
      let depreciationSchedule = [];
      if (depreciationMethod !== "none" && initialInvestment > 0) {
        const depreciableAmount = initialInvestment - salvageValue;
        
        if (depreciationMethod === "straight") {
          const annualDepreciation = depreciableAmount / periods;
          for (let i = 0; i < periods; i++) {
            depreciationSchedule.push(annualDepreciation);
          }
        } else if (depreciationMethod === "double") {
          const straightRate = 1 / periods;
          const doubleRate = 2 * straightRate;
          let remainingValue = initialInvestment;
          
          for (let i = 0; i < periods; i++) {
            let depreciation = remainingValue * doubleRate;
            // In last year, depreciate to salvage value
            if (i === periods - 1 || (remainingValue - depreciation) < salvageValue) {
              depreciation = remainingValue - salvageValue;
            }
            depreciationSchedule.push(depreciation);
            remainingValue -= depreciation;
          }
        }
      } else {
        depreciationSchedule = Array(periods).fill(0);
      }

      // Calculate taxable income and after-tax cash flows
      let afterTaxCashFlows = [];
      let taxableIncome = [];
      
      for (let i = 0; i < periods; i++) {
        const taxableInc = cashFlows[i] - depreciationSchedule[i];
        taxableIncome.push(taxableInc);
        const tax = Math.max(0, taxableInc) * taxRate;
        afterTaxCashFlows.push(cashFlows[i] - tax + depreciationSchedule[i]);
      }

      // Adjust for working capital (assumed to be recovered at the end)
      if (workingCapital !== 0) {
        afterTaxCashFlows[afterTaxCashFlows.length - 1] += workingCapital;
      }

      // Adjust for inflation
      let realCashFlows = [...afterTaxCashFlows];
      if (includeInflation && inflationRate > 0) {
        for (let i = 0; i < realCashFlows.length; i++) {
          realCashFlows[i] = realCashFlows[i] / Math.pow(1 + inflationRate, i + 1);
        }
      }

      // Calculate NPV
      let npv = -initialInvestment;
      for (let i = 0; i < realCashFlows.length; i++) {
        npv += realCashFlows[i] / Math.pow(1 + discountRate, i + 1);
      }

      // Calculate IRR (simplified approximation)
      let irr = 0;
      let precision = 0.0001;
      let maxIterations = 1000;
      let iterations = 0;
      
      function npvForRate(rate) {
        let total = -initialInvestment;
        for (let i = 0; i < realCashFlows.length; i++) {
          total += realCashFlows[i] / Math.pow(1 + rate, i + 1);
        }
        return total;
      }
      
      let low = -0.99;
      let high = 5.0; // 500% max
      
      while (iterations < maxIterations) {
        let mid = (low + high) / 2;
        let npvMid = npvForRate(mid);
        
        if (Math.abs(npvMid) < precision) {
          irr = mid;
          break;
        } else if (npvMid > 0) {
          low = mid;
        } else {
          high = mid;
        }
        
        iterations++;
      }
      
      irr = (low + high) / 2;

      // Calculate Payback Period
      let cumulativeCashFlow = -initialInvestment;
      let paybackPeriod = periods;
      
      for (let i = 0; i < periods; i++) {
        cumulativeCashFlow += realCashFlows[i];
        if (cumulativeCashFlow >= 0) {
          paybackPeriod = i + 1;
          break;
        }
      }

      // Calculate Profitability Index
      let pvCashInflows = 0;
      for (let i = 0; i < realCashFlows.length; i++) {
        pvCashInflows += realCashFlows[i] / Math.pow(1 + discountRate, i + 1);
      }
      const profitabilityIndex = pvCashInflows / initialInvestment;

      // Display results
      document.getElementById("npvResult").innerText = `Rs. ${npv.toFixed(2)}`;
      document.getElementById("npvResult").className = `metric-value ${npv >= 0 ? 'positive' : 'negative'}`;
      
      document.getElementById("irrResult").innerText = `${(irr * 100).toFixed(2)}%`;
      document.getElementById("irrResult").className = `metric-value ${irr >= discountRate ? 'positive' : 'negative'}`;
      
      document.getElementById("paybackResult").innerText = `${paybackPeriod} ${paybackPeriod === 1 ? 'year' : 'years'}`;
      
      document.getElementById("piResult").innerText = profitabilityIndex.toFixed(2);
      document.getElementById("piResult").className = `metric-value ${profitabilityIndex >= 1 ? 'positive' : 'negative'}`;
      
      // Investment decision
      let decision = "";
      if (npv >= 0 && irr >= discountRate && profitabilityIndex >= 1) {
        decision = "ACCEPT - Project meets all investment criteria";
      } else {
        decision = "REJECT - Project does not meet investment criteria";
      }
      document.getElementById("decisionResult").innerText = `Investment Decision: ${decision}`;
      document.getElementById("decisionResult").className = `result ${npv >= 0 ? '' : 'negative'}`;

      // Generate cash flow table
      let cashFlowTableHTML = `
        <table>
          <tr>
            <th>Year</th>
            <th>Cash Flow</th>
            <th>Depreciation</th>
            <th>Taxable Income</th>
            <th>Tax</th>
            <th>After-Tax Cash Flow</th>
            <th>Discounted CF</th>
            <th>Cumulative CF</th>
          </tr>
      `;
      
      let cumulativeCf = -initialInvestment;
      
      for (let i = 0; i < periods; i++) {
        const year = i + 1;
        const cf = cashFlows[i] || 0;
        const dep = depreciationSchedule[i] || 0;
        const taxableInc = taxableIncome[i] || 0;
        const tax = Math.max(0, taxableInc) * taxRate;
        const atcf = afterTaxCashFlows[i] || 0;
        const discountedCf = atcf / Math.pow(1 + discountRate, year);
        cumulativeCf += atcf;
        
        cashFlowTableHTML += `
          <tr>
            <td>${year}</td>
            <td>Rs. ${cf.toFixed(2)}</td>
            <td>Rs. ${dep.toFixed(2)}</td>
            <td>Rs. ${taxableInc.toFixed(2)}</td>
            <td>Rs. ${tax.toFixed(2)}</td>
            <td>Rs. ${atcf.toFixed(2)}</td>
            <td>Rs. ${discountedCf.toFixed(2)}</td>
            <td>Rs. ${cumulativeCf.toFixed(2)}</td>
          </tr>
        `;
      }
      
      cashFlowTableHTML += `</table>`;
      document.getElementById("cashFlowTable").innerHTML = cashFlowTableHTML;

      // Generate depreciation table if applicable
      if (depreciationMethod !== "none" && initialInvestment > 0) {
        let depreciationTableHTML = `
          <table>
            <tr>
              <th>Year</th>
              <th>Beginning Value</th>
              <th>Depreciation</th>
              <th>Ending Value</th>
            </tr>
        `;
        
        let beginningValue = initialInvestment;
        
        for (let i = 0; i < periods; i++) {
          const dep = depreciationSchedule[i] || 0;
          const endingValue = beginningValue - dep;
          
          depreciationTableHTML += `
            <tr>
              <td>${i + 1}</td>
              <td>Rs. ${beginningValue.toFixed(2)}</td>
              <td>Rs. ${dep.toFixed(2)}</td>
              <td>Rs. ${endingValue.toFixed(2)}</td>
            </tr>
          `;
          
          beginningValue = endingValue;
        }
        
        depreciationTableHTML += `</table>`;
        document.getElementById("depreciationTable").innerHTML = depreciationTableHTML;
      } else {
        document.getElementById("depreciationTable").innerHTML = "<p>No depreciation calculated.</p>";
      }

      // Generate simple sensitivity chart (text-based)
      const discountRates = [discountRate * 0.5, discountRate * 0.75, discountRate, discountRate * 1.25, discountRate * 1.5];
      let chartHTML = `<table><tr><th>Discount Rate</th><th>NPV</th></tr>`;
      
      discountRates.forEach(rate => {
        let sensNpv = -initialInvestment;
        for (let i = 0; i < realCashFlows.length; i++) {
          sensNpv += realCashFlows[i] / Math.pow(1 + rate, i + 1);
        }
        chartHTML += `<tr><td>${(rate * 100).toFixed(1)}%</td><td>Rs. ${sensNpv.toFixed(2)}</td></tr>`;
      });
      
      chartHTML += `</table>`;
      document.getElementById("npvChart").innerHTML = chartHTML;
    }
  </script>
</body>
</html>
